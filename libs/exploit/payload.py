"""
Payload Encoding/Decoding Module

Provides utilities for encoding and decoding exploit payloads.
"""

from typing import List, Optional
import base64


class PayloadEncoder:
    """
    Encoder for exploit payloads.
    
    Provides various encoding methods to avoid bad characters.
    """
    
    def __init__(self, bad_chars: Optional[List[int]] = None):
        """
        Initialize payload encoder.
        
        Args:
            bad_chars: List of bad byte values to avoid
        """
        self.bad_chars = bad_chars or []
    
    def encode(self, payload: bytes, method: str = 'xor') -> bytes:
        """
        Encode payload using specified method.
        
        Args:
            payload: Raw payload bytes
            method: Encoding method ('xor', 'base64', 'alpha', 'unicode')
            
        Returns:
            Encoded payload
        """
        if method == 'xor':
            return self.xor_encode(payload)
        elif method == 'base64':
            return self.base64_encode(payload)
        elif method == 'alpha':
            return self.alpha_encode(payload)
        elif method == 'unicode':
            return self.unicode_encode(payload)
        else:
            raise ValueError(f"Unknown encoding method: {method}")
    
    def xor_encode(self, payload: bytes, key: int = 0xAA) -> bytes:
        """
        XOR encode payload.
        
        Args:
            payload: Raw payload
            key: XOR key
            
        Returns:
            XOR-encoded payload
        """
        encoded = bytearray()
        for byte in payload:
            encoded.append(byte ^ key)
        return bytes(encoded)
    
    def base64_encode(self, payload: bytes) -> bytes:
        """
        Base64 encode payload.
        
        Args:
            payload: Raw payload
            
        Returns:
            Base64-encoded payload
        """
        return base64.b64encode(payload)
    
    def alpha_encode(self, payload: bytes) -> bytes:
        """
        Alpha-numeric encode payload (simplified).
        
        Args:
            payload: Raw payload
            
        Returns:
            Alpha-encoded payload
        """
        # This is a placeholder - real alpha encoding is complex
        # and requires specific instruction sequences
        return payload
    
    def unicode_encode(self, payload: bytes) -> bytes:
        """
        Unicode encode payload.
        
        Args:
            payload: Raw payload
            
        Returns:
            Unicode-encoded payload
        """
        # Convert to unicode representation
        encoded = bytearray()
        for byte in payload:
            # Represent each byte as two unicode bytes
            encoded.extend(f'{byte:02x}'.encode('utf-8'))
        return bytes(encoded)
    
    def check_bad_chars(self, payload: bytes) -> List[int]:
        """
        Check for bad characters in payload.
        
        Args:
            payload: Payload to check
            
        Returns:
            List of bad character positions
        """
        bad_positions = []
        for i, byte in enumerate(payload):
            if byte in self.bad_chars:
                bad_positions.append(i)
        return bad_positions


class PayloadDecoder:
    """
    Decoder for encoded exploit payloads.
    """
    
    def decode(self, payload: bytes, method: str = 'xor', key: int = 0xAA) -> bytes:
        """
        Decode payload using specified method.
        
        Args:
            payload: Encoded payload
            method: Decoding method
            key: Decoding key (for XOR)
            
        Returns:
            Decoded payload
        """
        if method == 'xor':
            return self.xor_decode(payload, key)
        elif method == 'base64':
            return self.base64_decode(payload)
        elif method == 'alpha':
            return self.alpha_decode(payload)
        elif method == 'unicode':
            return self.unicode_decode(payload)
        else:
            raise ValueError(f"Unknown decoding method: {method}")
    
    def xor_decode(self, payload: bytes, key: int = 0xAA) -> bytes:
        """XOR decode payload."""
        decoded = bytearray()
        for byte in payload:
            decoded.append(byte ^ key)
        return bytes(decoded)
    
    def base64_decode(self, payload: bytes) -> bytes:
        """Base64 decode payload."""
        return base64.b64decode(payload)
    
    def alpha_decode(self, payload: bytes) -> bytes:
        """Alpha-numeric decode payload."""
        # Placeholder
        return payload
    
    def unicode_decode(self, payload: bytes) -> bytes:
        """Unicode decode payload."""
        # Placeholder
        return payload

